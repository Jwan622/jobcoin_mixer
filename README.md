## Jobcoin Mixer


# Table of Contents
1. [Getting Started](#getting-started)
2. [How to use the app](#app-usage)
3. [Code Analysis](#code-analysis)
   1. [TransactionHandler](#transaction-handler)
   2. [Distributors](#distributors)
   3. [Edge Cases](#edge-cases)
4. [Image Choice](#image-choice)

# Getting Started

After cloning the repo, cd into the folder and run:

```
rackup -p 3000
```
and go to `localhost:3000` in your browser.

(You might have to run `bundle install` if you see any errors, but I believe the `config.ru` file is written so that you only need to run the `rackup` command.)


Do not run the application using ruby:

```ruby
ruby './app.rb' -p 3000
```
The above will bypass the configuration in `config.ru`

# App Usage
After going to localhost:3000:

1. Fill in your addresses to mix. These addresses are the ones you are trying to make transfers to opaque. You can enter 1 or more addresses. If you enter in 2 addresses and your company transfers 2 Jobcoins to the generated mixed address, our mixer will distribute 1 Jobcoin to each address.
2. Once you've entered in the addresses, click the 'Mix
addresses' button. The app will provide you a mixed address that you can direct transfers to.
3. Once you received your mixed address, you will see a deposit section where you can enter in the address that you wish to send Jobcoins from in the `Deposit From` box. Your new mixed addresses should already be prepopulated in the `Deposit To` box.
4. Enter in the deposit amount.
5. Click Deposit. At this point, the application will transfer Jobcoin from the address that you entered in the `Deposit From` box to the mixed address that was in the `Deposit To` box. After that's complete, the Jobcoin will then be transferred to a House Account belonging to the application. Finally, the Jobcoin is evenly distributed to the addresses that were originally used to create the mixed address.
7. Wait for confirmation message "Deposit Complete!" to appear in red. At that point, the Jobcoin that was sent to the mixed address should have transferred back to your original address(es).

#### Example
Say you own 2 addresses: Addr1 and Addr2. Your company's boss Sam wants to transfer 5 Jobcoin to you. So, you provide Sam your mixed address (let's call it Addr3) and he makes the transfer of 5 Jobcoin to the mixed address. He enters in your mixed address, his address, and 5 Jobcoin into the deposit form and submits the form.

4 transactions should have taken place:
- Transfer from Sam to Addr3 (the mixed address) for 5 Jobcoin.
- Transfer from Addr3 to the House Account for 5 Jobcoin.
- Transfer from the House Account to Addr1 for 2.5 Jobcoin.
- Transfer from the House Account to Addr2 for 2.5 Jobcoin.

# Code Analysis

Let's give a bit into the code and decisions.

### Transaction Handler

Let's say we have these transactions.

```
[
  {"timestamp"=>"2018-01-18T02:57:34.959Z", "toAddress"=>"Alice", "amount"=>"50"},
  {"timestamp"=>"2018-01-18T02:57:35.016Z", "fromAddress"=>"Alice", "toAddress"=>"Bob", "amount"=>"12.5"},
  {"timestamp"=>"2018-01-18T16:53:16.747Z", "toAddress"=>"50", "amount"=>"50"},
  {"timestamp"=>"2018-01-18T16:53:27.572Z", "fromAddress"=>"50", "toAddress"=>"alice", "amount"=>"50"},
  {"timestamp"=>"2018-01-18T16:53:38.853Z", "fromAddress"=>"alice", "toAddress"=>"Alice", "amount"=>"50"},
  {"timestamp"=>"2018-01-23T23:35:03.792Z", "fromAddress"=>"Alice", "toAddress"=>"alice", "amount"=>"10"},
  {"timestamp"=>"2018-01-23T23:35:25.464Z", "fromAddress"=>"Alice", "toAddress"=>"Bob", "amount"=>"1"},
  {"timestamp"=>"2018-01-23T23:35:48.835Z", "fromAddress"=>"Alice", "toAddress"=>"Bob", "amount"=>"1"},
  {"timestamp"=>"2018-01-23T23:47:46.485Z", "fromAddress"=>"Alice", "toAddress"=>"Bob", "amount"=>"1"},
  {"timestamp"=>"2018-01-23T23:48:31.953Z", "fromAddress"=>"Alice", "toAddress"=>"Bobz", "amount"=>"1"},
  {"timestamp"=>"2018-01-24T18:11:04.444Z", "fromAddress"=>"Alice", "toAddress"=>"Bobz", "amount"=>"1"}
]
```

The `TransactionHandler` will filter transactions that were sent to mixed addresses generated by our `JobcoinMixer`.

```ruby
TransactionHandler.new(transaction_history, HouseDistributor::IDENTIFIER).process
```

In the above code, the `TransactionHandler` polls the Jobcoin history for transactions that sent to addresses created by the Mixer. These addresses can then be used to send money from the mixed address to the House Account.

```ruby
{"toAddress"=>"52c7ec313568730cbadff4cb7b59dd5696d9917393f07ba92d74a6b3d1cc93a4057dd6ab03ddde6d938180ff", "amount"=>10.0, "fromAddress"=>["1444"]}]
[{"toAddress"=>"0297bc772c4f6854b5eae2ce674fcf46f23d3574f1f13989919faaaf11c873", "amount"=>50.256899999999995, "fromAddress"=>["1444", "alice", "Alice"]},
 {"toAddress"=>"52cfe12035675455afcdc4dd6852dd4499463ce04f1c37bb17c645b26b4b4116", "amount"=>2.11, "fromAddress"=>["1444"]},
 {"toAddress"=>"52c7ec313568730cbadff4cb7b59dd5696d9917393f07ba92d74a6b3d1cc93a4057dd6ab03ddde6d938180ff", "amount"=>10.0, "fromAddress"=>["1444"]}]
```

Only the above addresses will be returned.


__NOTE__: Composition helps here to make this TransactionHandler more reusable. Provide it a set of transactions and an identifer and the handler will return only transactions with a `toAddress` encrypted by the identifier.


### Distributors

Issues:
1. How to make the methods idempotent. If one fails, I should be able to safely rerun the methods without running the risk of duplicate transfers.


- The house account has all the aggregated jobcoins. The issue here is determining which accounts to transfer jobcoins to while also avoiding duplicate
transfers.

### Edge Cases
1. Say you mix 3 addresses into an address, let's call it AddressB. IF you then deposit an amount of
JobCoin into AddressB that does not divide evenly 3 ways, you wind up with more coins. For example,
Say you mix 3 addresses and then try to transfer 2.3 JobCoin to the mixed address. Each of the
three addresses will receive 0.7666666666666667 JobCoin which, when multiple by 3,
comes out to more than 2.3. This is a bug that should be fixed since we can create infinite
JobCoin this way.



# Image Choice
This multi-layered structure in the Yo Dawg meme makes it reminiscent of the “strange loops” described in Douglas Hofstadter’s Gödel, Escher, Bach. Strange loops occur when, by moving only upwards or downwards through a system, one finds oneself back where one started... kind of like what goes on in this mixer system. So, the Xhibit meme was the one clear choice.
